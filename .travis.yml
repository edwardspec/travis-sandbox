dist: trusty
sudo: false
language: php

git:
  depth: 1

notifications:
  email: false

services:
  - mysql
  - memcached

matrix:
  include:
    - env: branch=REL1_31 dbtype=mysql dbuser=root
      php: 7.2
    - env: branch=REL1_27 dbtype=mysql dbuser=root
      php: 7.1

cache:
  directories:
    - buildcache

before_script:
# Install gdb and unpack sources of PHP to obtain a nice stack trace
# of PHP's SEGFAULT in zend_hash_find_bucket() when uopz_set_return() was used.
#  - wget https://php.net/distributions/php-7.2.6.tar.bz2
#  - mkdir -p /tmp/php-build/source
#  - tar -xjf php-7.2.6.tar.bz2
#  - rm -rf /tmp/php-build/source/7.2.6
#  - mv php-7.2.6 /tmp/php-build/source/7.2.6
#  - sudo apt-get install -y gdb
###############################################################################
  - pecl install uopz
  - phpenv config-rm xdebug.ini
  - phpenv config-add phpconf/php.ini
  - php -i
  - bash -ex ./build_mediawiki.sh "$branch"
  - wget https://github.com/edwardspec/mediawiki-moderation/archive/master.zip
  - unzip master.zip
  - mv mediawiki-moderation-master mediawiki/extensions/Moderation
  - cd mediawiki
  - >
      php maintenance/install.php traviswiki admin
      --pass travis
      --dbtype "$dbtype"
      --dbname traviswiki
      --dbuser "$dbuser"
      --dbpass ""
      --scriptpath "/w"
  - echo -en "\n\nrequire_once __DIR__ . '/includes/DevelopmentSettings.php';\n" >> ./LocalSettings.php
  - echo -en "\n\nrequire_once __DIR__ . '/../ModerationSettings.php';\n" >> ./LocalSettings.php
  - php -l ./LocalSettings.php
  - php maintenance/update.php --quick
  - sed -i 's/if ( !self::$dbSetup || $this->needsDB() )/if ( 0 )/' tests/phpunit/MediaWikiTestCase.php
#  - cd extensions/Moderation && patch -p1 <../../../patches/moderation-cli-gdb.patch && cd -
# Remove the use of header_register_callback(), causes PHP7.2+uopz to segfault
  - sed -i 's/^.*header_register_callback.*$//' includes/HeaderCallback.php

script:
  - MODERATION_TEST_ENGINE=cli php tests/phpunit/phpunit.php extensions/Moderation/
