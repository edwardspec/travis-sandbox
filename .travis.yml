dist: trusty
sudo: false
language: php

git:
  depth: 1

notifications:
  email: false

services:
  - mysql
  - memcached

env:
  global:
    - DBTYPE=mysql
    - DBUSER=root
    - secure: "H/cJhINd4ASy+dMmm0m2nCFd4eFRZrnQ46zb25doLPnCsIGGUlQ8J0oE+caokmFRBIP8KBciqUo+pNUZW0IBIAl8Eh9bjUu3kdiFN9Fhj58V6CrJPtnwnXpHRkP6oTvqeSXP59YHv2qVFGlxaYAo4j4Uefig5CdOTfuTIVC4uV6drKCqP85jRg75joNMFgK0SGBYubK7/UpJnjxk4CcSDbhZWyw1iTTjbTz7sCu9hXXeuYZlma96au2KnA0acbLunJXPuF7b7htkG2bSqzuT5bnFy74jOjTsCG67YAPExP7HF2M0++63vVhrqJBUYVmWIvlNNAGdx5Fb+pOIHw9vH144Eg0n93K8hm5jKnADj3gVR5lfdvCj/DrBlxcdnrCDfgZfkbKoGRfUxQjOaC0OyyJXuqibnqvviuQTmno30/QK2k7VahshryYrwf6YchCcaSauAud2w4Jnfpl/R+a9cLeBamzkyOcjmf4n2T+FUoUI3b8fOUiXRp+5MKcNYhQx5hC0zWjgPRmX2gzW6nmIsbzLMKwhpaty7HHIgzqPmbZXyAFjuMdJxWLqofqlQtCvitZnuoh6ZaPDBut8HPvOnrYuyCBZKuDKpp9niIA0JXJwTVHViza79EMyurMqV/K9LZTZpdnjQfB0oKgBeyNpCJmMyiMnkO4rIk3u1ZecA6I="
    - secure: "QaAzFIR3qWqEle11gpQyJzx1gg9Mq6wCDoGoFVgRJddPUriipfYmke+fOLgKCy4jpOC8SV3qQRonQXhRNh3XZab2Le0aBnViEXHpmF/plk3hYpZKE9OglbJH8wig1+pjaB5ZFu/lh3ln3fBPuAeycvPmgqpIhqDQb3GrVYezcu6DOtJh5tomIRbjXz10Dkmp5AbLb5GlAUUUC9OW3ocusbhYl1zLk2Mqoqib7qEmVcvkc4ZCZ/eIkp7g+nBMHornMdIrV5jdWpKXNacZLAcx6ydAf7C0JpDO8cpxgTKOpjj6lHAPqzFVr1e9qovOz1YhAjz7oFcLlrJCkYK3At+Bs1TNNzhZ7tDpOFbFHmsIe+bsQrI6loq+OoVabvJVGlgcqbbRRPfQ3ipK5IJniNUDYRNd1R6A2TsGcCQR0kn5EuSd/RGbrIhMeCA4n3KmwdEvSFIjFzVrcPd/Dgae4AA5isAOBHvnaZvCGeB9wXMsZhaAihqUXVAZWvQ5C0KH+uuFoYX54sN+sFo9dLb8w8BhKbxgxhGFzP4/mlIWxu0WqTQcOHgHDTOcn538+unfowhuVvEC2Nej3ejI1e2xh90xvMIx47mSLt1Tv+YE5ZIH7q/b7ynKwnoryweWtmEafElXOKbiC3HGaeGVfbqNhgBU9DIjpB+PYlVPzGwtoRNcB+E="
    - secure: "eXrZ6eTPgJ64pr+79Zn1XAWZklKcf+3z7FqnKYjkCsbJD0yhrX6aF5v+FUVJOTiENMo7950KPQx/q1OT5d4pydb/E8QzAumXDMntm/Zghwzk/9YiSd4xnp2/w3YMqdKfu/N2adO2qIZhOPjJNm5ovHn3iKtKTJ3Bu6SbCO9ghZAPnce2ajB54E07p7+pQbGo9SzfFOfVBwvfSOuo8TC5Egnh4QHd+rrpepg5+qGAC+hy2Vimzd6m50S99hJEe49d+MOqrybq5MmwaXrZw1wng+o4bvXtBwwx/WzpmQ/9UTY1eDbTMfFLt2DasSpaMTpkkGNTe5zRSDC9Qm/4yHEYzD8kVI2s0Syc24Ow5q7zR4BCi5GRvHBkN4t3Vp5dAL4XQuFRpnexNn3PYbysbTL5sm0i1BKYOkoM1eqvV7h0+PYAyVdirlC3c9qCCzPE5CHvZG03FRw5b4Ih0x5bsmkCP4fC7Mj9ImUCKypDCBfISJB0qlwKkfWQOVUL0/lzTGIyZSwk6GKickovww3G2SGf9ESWfQqGm83NSAuUX0etHaJxrwXjy7MfnRaDsnNU2CnMLaDvlG0vg1aD4RLKK3bvPmdL5PjP7dKIe+Ky9GYdiCQaPGbn/OqWo0DxhSyW/ExM27RmjfR7KJNEXAz8vk0FYUhp/UzT3eDV8zDjT6u0is8="

matrix:
  include:
    - env: branch=REL1_31
      php: 7.2
#    - env: branch=REL1_27 dbtype=mysql dbuser=root
#      php: 7.1

cache:
  directories:
    - buildcache

before_script:
  - echo $HELLO
  - phpenv config-rm xdebug.ini
#  - phpenv config-add phpconf/php.ini
  - bash -ex ./build_mediawiki.sh "$branch"
  - wget https://github.com/edwardspec/mediawiki-aws-s3-stable-fork/archive/master.zip
  - unzip master.zip
  - mv mediawiki-aws-s3-stable-fork-master mediawiki/extensions/AWS
  - cd mediawiki/extensions/AWS && composer install && cd -
  - cd mediawiki
  - >
      php maintenance/install.php traviswiki admin
      --pass travis
      --dbtype "$DBTYPE"
      --dbname traviswiki
      --dbuser "$DBUSER"
      --dbpass ""
      --scriptpath "/w"
  - echo -en "\n\nrequire_once __DIR__ . '/includes/DevelopmentSettings.php';\n" >> ./LocalSettings.php
  - echo -en "\n\nrequire_once __DIR__ . '/../AWSSettings.php';\n" >> ./LocalSettings.php
#  - echo -en "\n\nrequire_once __DIR__ . '/../ModerationSettings.php';\n" >> ./LocalSettings.php
  - php -l ./LocalSettings.php
  - php maintenance/update.php --quick
#  - sed -i 's/if ( !self::$dbSetup || $this->needsDB() )/if ( 0 )/' tests/phpunit/MediaWikiTestCase.php
#  - grep needsDB tests/phpunit/MediaWikiTestCase.php
#  - cd extensions/Moderation && patch -p1 <../../../patches/moderation-vardump-rctags.patch && cd -

script:
#  - MODERATION_TEST_ENGINE=cli php tests/phpunit/phpunit.php extensions/Moderation/
#  - MODERATION_TEST_ENGINE=cli php tests/phpunit/phpunit.php extensions/Moderation/tests/phpunit/ModerationAbuseFilterTest.php
  - MODERATION_TEST_ENGINE=cli php tests/phpunit/phpunit.php extensions/AWS/tests/phpunit/
